<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head th:include="include :: header">

    <style>
        #canvasOne {
            border: 1px solid #ddd;
        }
    </style>
</head>

<body class="gray-bg" onload="init();">

<div class="container-div">
    <div class="row">
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>流媒体直播</h5>
                    <div class="ibox-tools">
                    </div>
                </div>
                <div class="ibox-content">
                    <p class="text-warning">测试直播IMEI为：<span id="test"></span></p>
                    <div id="livestatus">
                        <p class="text-primary" >未直播</p>
                    </div>
                    <div id="rtmp-streamer" >
                        <h3>请先安装flash插件</h3>
                        <p><a href="http://www.adobe.com/go/getflashplayer"><img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="下载 Adobe Flash player 插件" /></a></p>
                    </div>
                    <div >
                        <button id="start" class="btn btn-primary"   onclick="startlive(this);"  >
                            <i  class="ace-icon fa fa-play bigger-110 "></i>&nbsp;开启直播</button>
                        <button id="end" class="btn btn-danger"  disabled onclick="endlive();"   >
                            <i  class="ace-icon fa fa-stop bigger-110 " ></i>&nbsp;关闭直播</button>
                    </div>
                    <div style="font-size:12px;margin-top:20px;">
                        <p  class="text-warning" >直播终端：<span id="liveternum">0</span> 个，开启直播：<span id="startternum">0</span> 个</p></div>
                    <div>
                        <h1>直播声音频域图</h1>
                        <canvas id="canvasOne" width="400"></canvas>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-sm-8">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>终端直播状态</h5>
                </div>
                <div class="ibox-content">
                    <form action="" method="post" name="Form" id="Form">
                        <table id="simple-table"  class="table table-striped table-bordered table-hover">
                            <thead>
                            <tr>
                                <th class="center">终端IMEI</th>
                                <th class="center">流媒体ID</th>
                                <th class="center">记录状态</th>
                            </tr>
                            </thead>
                            <tbody id="tbody">
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>

            <div class="ibox float-e-margins">
                <input name="deptId"  type="hidden" id="treeId"/>
                <div class="form-group">
                    <label class="col-sm-3 control-label">选择终端: </label>
                    <div class="col-sm-8">

                        <input class="form-control" type="text" name="organName" onclick="selectOrganTree()" readonly="true" id="treeName">
                    </div>
                    <label class="col-sm-3 control-label">选择文件: </label>
                    <div class="col-sm-8">
                        <input class="form-control" readonly="true" id="file" type="text" onclick="doFile();" name="">
                    </div>

                    <button class="button" style="margin-top: 43px" onclick="flushfile();">播放文件</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //文件转播选择
    function doFile() {
        var baseTime = "08:00:00";
        if($("#broaddate").val() == ""){
            layer.tips('请选择播出日期','#broaddate', {
                tips: [1, '#3595CC'],
                time: 4000
            });
            return false;
        }
        var data = $("#broaddate").val();

        //console.log("timeFile="+time);
        var _url = "/broad/live/getdoFile";
        var _title = '文件选择';
        var _width = "1200";
        var _height = ($(window).height() - 50);
        layer.open({
            type: 2,
            maxmin: true,
            shade: 0.3,
            title: _title,
            fix: false,
            area: [_width + 'px', _height + 'px'],
            content: _url,
            shadeClose: true,
            btn: ['<i class="fa fa-check"></i> 确认', '<i class="fa fa-close"></i> 关闭'],
            yes: function (index, layero) {
                layer.close(index);
                //获取子页面关闭前的回调函数获取到的值
                var res = $(layero).find("iframe")[0].contentWindow.callbackfile();
                var filename = res.data_filename;
                var fid = res.data_file;
                //console.log("文件id:"+fid+",文件名称："+filename);
                $("#file").attr("name",fid);
                $("#file").val(filename)
            }, cancel: function () {
                return true;
            }
        });
    }
    //播放文件
    function flushfile() {
        console.log($("#file").attr("name"));
        // 如果未选择则 提示要选择
        if(imeilist==null || imeilist==""){
            $.modal.confirm("无测试终端，请查看源码调试 ----》 方法startlive(obj)");
            return false;
        }else{
            console.log($("#start").attr("disabled")+"-----"+$("#end").attr("disabled"))
            if(typeof $("#start").attr("disabled") =="undifined" && typeof $("#end").attr("disabled") =="undifined"){
                console.log("请稍后。。。")
            }else if(typeof $("#start").attr("disabled") =="undifined" && typeof $("#end").attr("disabled") =="disabled"){
                console.log("开启状态。。。")
            }else if(typeof $("#start").attr("disabled") =="disabled" && typeof $("#end").attr("disabled") =="undifined"){
                console.log("关闭状态。。。")
            }else {
                console.log("my")
            }
        }


    }
</script>
<script th:src="@{/js/plugins/live/recorder-core.js}"></script>
<script th:src="@{/js/plugins/live/FileSaver.js}"></script>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/content.min.js}"></script>
    <script th:src="@{/js/views/live/swfobject.min.js}"></script>
    <script th:src="@{/js/views/live/livestreamtest.js}"></script>
    <script th:src="@{/ajax/libs/select/select2.js}"></script>
    <script th:src="@{/ajax/libs/layer/layer.min.js}"></script>
<script th:src="@{/js/plugins/live/engine/mp3.js}"></script>
<script th:src="@{/js/plugins/live/engine/mp3-engine.js}"></script>
    <script type="text/javascript">
        function RandomKey(){
            return "randomkey"+(RandomKey.idx++);
        };
        RandomKey.idx=0;

        var ctx;
        var audioContext;
        var analyser;
        var mic;

        var rec;
        var recblob={};
        var wave;
        function init() {
            canvasOne = document.getElementById('canvasOne');
            ctx = canvasOne.getContext("2d");
            var type="mp3";
            var bit=16;
            var sample=16000;
            rec=Recorder({
                type:type
                ,bitRate:bit
                ,sampleRate:sample
                ,onProcess:function(buffers,level,time,sampleRate){
                    wave.input(buffers[buffers.length-1],level,sampleRate);
                }
            });

        }
        /**
         * 结束直播命令
         */
        function endlive(){
            setLiveButton(3);
            scrollStatus("text-info","正在关闭直播...");
            addlog("close",streamid,imeilist);

            console.log("关闭成功1")
            if(rec){
                rec.stop(function(blob,time){
                    var id=RandomKey(16);
                    recblob[id]={blob:blob,set:$.extend({},rec.set),time:time};
                    recdown(id);
                    console.log("关闭成功2")
                },function(s){
                    console.log("关闭失败222")
                });
            };
            console.log("关闭成功3")
            if(isOpen) streamerDisconnect();
            if (ws != null) {
                var message = "end:"+streamid;
                console.log('Sent End');
                ws.send(message);
            } else {
                setLiveButton(2);
            }

        }
        function recdown(key){
            var o=recblob[key];
            /**
             * 下载文件
             */
            console.log("----here")
            if(o){
                var cls=RandomKey(16);
                var name="rec-"+o.time+"ms-"+o.set.bitRate+"kbps-"+o.set.sampleRate+"hz."+o.set.type;
                o.down=(o.down||0)+1;
                var downA=document.createElement("A");
                console.log(o.blob)
                downA.innerHTML="下载 "+name;
                downA.href=URL.createObjectURL(o.blob);
                downA.download=name;
                $("."+cls).prepend(downA);
                downA.click();
            };
        };
        /**
         * 开始直播
         * @param obj
         * @returns {boolean}
         */
        function startlive(obj){
            // 如果未选择则 提示要选择
            if(imeilist==null || imeilist==""){
                $.modal.confirm("无测试终端，请查看源码调试 ----》 方法startlive(obj)");
                return false;
            }else{
                // 设置 streamid 为当前时间
                streamid = getCurTime();

                rec.open(function(){
                    console.log("打开成功22");
                },function(e,isUserNotAllow){
                    console.log("不允许")
                });
                if(rec){
                    rec.start();
                    console.log("开启22")
                };
                setLiveButton(0);
                // 推流
                publishRtmp();
            }
        }
        navigator.getMedia = ( navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);

        navigator.getMedia ( { audio: true }, function (stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext);
            mic = audioContext.createMediaStreamSource(stream);
            analyser= audioContext.createAnalyser();
            analyser.fftSize = 256;
            mic.connect(analyser);
            drawSpectrum();
        },function(){});

        function drawSpectrum() {
            var WIDTH = canvasOne.width;
            var HEIGHT= canvasOne.height;
            var array =  new Uint8Array(128);
            analyser.getByteFrequencyData(array);
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            for ( var i = 0; i < (array.length); i++ ){
                var value = array[i];
                ctx.fillRect(i*5,HEIGHT-value,3,HEIGHT);
            }
            requestAnimationFrame(drawSpectrum);
        };


    </script>
    <script type="text/javascript">
        var context1;
        try {
            context1 = new (window.AudioContext || window.webkitAudioContext);
        } catch(e) {
            throw new Error('The Web Audio API is unavailable');
        }
        window.addEventListener('load', function(e) {
            drawSpectrumfa();
        }, false);
        function drawSpectrumfa() {
            var array =  new Uint8Array(128);
            requestAnimationFrame(drawSpectrumfa);
        }


        /*流媒体直播-选择终端树*/
        function selectOrganTree() {
            var _url = "/broad/organization/selectOrganizationTree/01";
            var _title = '选择终端';
            var _width = "1200";
            var _height = ($(window).height() - 50);
            layer.open({
                type: 2,
                maxmin: true,
                shade: 0.3,
                title: _title,
                fix: false,
                area: [_width + 'px', _height + 'px'],
                content: _url,
                shadeClose: true,
                btn: ['<i class="fa fa-check"></i> 确认', '<i class="fa fa-close"></i> 关闭'],
                yes: function (index, layero) {
                    doSubmit(index, layero)
                }, cancel: function () {
                    return true;
                }
            });
        }

        function doSubmit(index, layero){
            var tree = layero.find("iframe")[0].contentWindow.$._tree;
           /* if ($.tree.notAllowParents(tree)) {*/
                var body = layer.getChildFrame('body', index);
                $("#treeId").val(body.find('#treeId').val());
                $("#treeName").val(body.find('#treeName').val());
                layer.close(index);
            /*}*/
        }

    </script>


</body>
</html>